name: CI/CD pipeline

on:
  push:

jobs:
  tests:
    name: "Tests"
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
  
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.x'

    - uses: actions/cache@v4
      with:
        path: |
          ~/.nuget/packages
          ~/.dotnet/packs
          ~/.dotnet/workloadmanifests
          ~/.dotnet/sdk-manifests
        key: ${{ runner.os }}-dotnet-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-dotnet-

    - name: Restore solution
      run: |
          dotnet workload restore
          dotnet restore

    - name: Run tests
      run: dotnet test --no-restore --verbosity normal --logger "trx;LogFileName=tests-results.trx"

    - name: Publish test reports
      uses: dorny/test-reporter@v2
      if: ${{ !cancelled() }}
      with:
         name: Tests
         path: '**/tests-results.trx'
         reporter: dotnet-trx

  build:
    name: Build
    runs-on: macos-latest
    needs: tests

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
  
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.x'

    - uses: actions/cache@v4
      with:
        path: |
          ~/.nuget/packages
          ~/.dotnet/packs
          ~/.dotnet/workloadmanifests
          ~/.dotnet/sdk-manifests
        key: ${{ runner.os }}-dotnet-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-dotnet-

    - name: Restore solution
      run: |
          dotnet workload restore
          dotnet restore

    - name: Decode keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > keystore.jks

    - name: Build signed AAB
      run: |
        dotnet publish ScheduleMADI/ScheduleMADI.csproj \
          -c Release -f net9.0-android35.0 \
          -o:releaseOut/ \
          -p:AndroidKeyStore=true \
          -p:AndroidPackageFormat=aab \
          -p:AndroidSigningKeyStore=../keystore.jks \
          -p:AndroidSigningStorePass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
          -p:AndroidSigningKeyAlias=${{ secrets.ANDROID_KEYSTORE_ALIAS }} \
          -p:AndroidSigningKeyPass=${{ secrets.ANDROID_KEY_PASSWORD }} 

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build
        path: |
          ./releaseOut/com.wildchair.schedulemadi-Signed.aab
          ./releaseOut/com.wildchair.schedulemadi-Signed.apk